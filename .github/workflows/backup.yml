name: Daily Supabase Database Backup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 21 * * *'

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: âš™ï¸ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # --- NEW STEP: Ensure the directory exists ---
      - name: ğŸ“‚ Create Backup Directory
        run: mkdir -p supabase/backups

      # --- 1. Backup Roles ---
      - name: ğŸ’¾ Backup Roles
        run: supabase db dump --db-url "${{ secrets.SUPABASE_DB_URL }}" -f supabase/backups/roles.sql --role-only
        
      # --- 2. Backup Schema ---
      - name: ğŸ’¾ Backup Schema
        run: supabase db dump --db-url "${{ secrets.SUPABASE_DB_URL }}" -f supabase/backups/schema.sql
        
      # --- 3. Backup Data ---
      - name: ğŸ’¾ Backup Data
        run: supabase db dump --db-url "${{ secrets.SUPABASE_DB_URL }}" -f supabase/backups/data.sql --data-only --use-copy

      - name: ğŸ“… Commit Backup Files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(backup): Daily Supabase DB Backup"
          file_pattern: supabase/backups/*.sql
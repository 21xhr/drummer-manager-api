generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ChallengeStatus {
  Active
  Archived
  Auctioning
  InProgress
  Completed
  Removed
}

/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model User {
  id                                       Int         @id @default(autoincrement()) @map("user_id")
  platformId                               String      @map("user_platform_id")
  platformName                             String      @map("platform_name")
  lastKnownBalance                         Int         @default(0) @map("last_known_balance")
  lastBalanceUpdate                        DateTime?   @map("last_balance_update")
  lastActivityTimestamp                    DateTime?   @map("last_activity_timestamp")
  lastLiveActivityTimestamp                DateTime?   @map("last_live_activity_timestamp")
  lastSeenStreamDay                        Int         @default(0) @map("last_seen_stream_day")
  activeOfflineDaysCount                   Int         @default(0) @map("active_offline_days_count")
  activeStreamDaysCount                    Int         @default(0) @map("active_stream_days_count")
  totalNumbersSpentGameWide                Int         @default(0) @map("total_numbers_spent_game_wide")
  totalNumbersReturnedFromRemovalsGameWide Int         @default(0) @map("total_numbers_returned_from_removals_game_wide")
  totalCausedByRemovals                    BigInt      @default(0) @map("total_caused_by_removals") // Tracks total NUMBERS the user has caused to be forfeited/refunded from removals
  totalToCommunityChest                    BigInt      @default(0) @map("total_to_community_chest") // Tracks total liability directed to the Community Chest by this user's removals.
  totalToPushers                           BigInt      @default(0) @map("total_to_pushers") // Tracks total liability directed to Pushers by this user's removals.

  // Game Metrics (User)
  dailyChallengeResetAt                    DateTime    @map("daily_challenge_reset_at")
  dailySubmissionCount                     Int         @default(0) @map("daily_submission_count")
  totalChallengesSubmitted                 Int         @default(0) @map("total_challenges_submitted")
  totalRemovalsExecuted                    Int         @default(0) @map("total_removals_executed")
  totalReceivedFromRemovals                Int         @default(0) @map("total_received_from_removals")
  totalNumbersSpent                        Int         @default(0) @map("total_numbers_spent")
  totalDigoutsExecuted                     Int         @map("total_digouts_executed") @default(0)
  totalPushesExecuted                      Int         @default(0) // Tracks total number of *pushes* (quantity) made by the user.
  totalDisruptsExecuted Int @default(0) // Tracks total disrupt commands run by the user.

  challenges                               Challenge[] @relation("Proposer")
  pushes                                   Push[]
  tempQuotes                               TempQuote[]

  @@unique([platformId, platformName])
  @@map("users")
}

/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model StreamStat {
  id                       Int @id @default(autoincrement())
  streamDaysSinceInception Int @default(0) @map("stream_days_since_inception")
  daysSinceInception       Int @default(0) @map("days_since_inception")

  @@map("stream_stats")
}

/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model Challenge {
  challengeId               Int         @id @default(autoincrement()) @map("challenge_id")
  challengeText             String      @map("challenge_text")
  category                  String      @map("category")
  durationType              String      @map("duration_type")
  proposerUserId            Int         @map("proposer_user_id")
  status                ChallengeStatus @map("status")
  isExecuting               Boolean     @default(false) @map("is_executing")
  hasBeenAuctioned          Boolean     @default(false) @map("has_been_auctioned")
  hasBeenDiggedOut          Boolean     @default(false) @map("has_been_digged_out")
  auctionCost               Int         @default(0) @map("auction_cost")
  disruptCount              Int         @default(0) @map("disrupt_count")
  numbersRaised             Int         @default(0) @map("numbers_raised")
  totalNumbersSpent         Int         @default(0) @map("total_numbers_spent")
  totalPush                 Int         @default(0) @map("total_push")
  timestampSubmitted        DateTime    @map("timestamp_submitted")
  timestampLastActivation   DateTime    @map("timestamp_last_activation")
  timestampCompleted        DateTime?   @map("timestamp_completed")
  uniquePusher              Int         @default(0) @map("unique_pusher")
  pushBaseCost              Int         @default(21) @map("push_base_cost")
  proposer                  User        @relation("Proposer", fields: [proposerUserId], references: [id])
  timestampLastStreamDayTicked   DateTime    @default(now()) // Tracks the last time streamDaysSinceActivation was incremented. To guard against double-ticking
  
  // Lifecycle fields
  streamDaysSinceActivation Int         @default(0) @map("stream_days_since_activation")
  
  pushes                    Push[]
  tempQuotes                TempQuote[]


  @@map("challenges")
}

/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model Push {
  pushId      Int       @id @default(autoincrement()) @map("push_id")
  challengeId Int       @map("challenge_id")
  userId      Int       @map("user_id")
  cost        Int       @map("cost")
  timestamp   DateTime  @default(now()) @map("timestamp")
  quantity    Int       @default(1) @map("quantity")
  challenge   Challenge @relation(fields: [challengeId], references: [challengeId])
  user        User      @relation(fields: [userId], references: [id])

  @@map("pushes")
}

/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model TempQuote {
  quoteId          String    @id @map("quote_id")
  userId           Int       @map("user_id")
  challengeId      Int       @map("challenge_id")
  quantity         Int       @map("quantity")
  quotedCost       Int       @map("quoted_cost")
  timestampCreated DateTime  @map("timestamp_created")
  isLocked         Boolean   @default(false) @map("is_locked")
  challenge        Challenge @relation(fields: [challengeId], references: [challengeId])
  user             User      @relation(fields: [userId], references: [id])

  @@map("temp_quotes")
}

/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model Stream {
  streamSessionId                           Int       @id @default(autoincrement()) @map("stream_session_id")
  currentStreamNumber                       Int       @map("current_stream_number")
  startTimestamp                            DateTime  @map("start_timestamp")
  endTimestamp                              DateTime? @map("end_timestamp")
  durationMinutes                           Int?      @map("duration_minutes")
  totalPushesInSession                      Int       @default(0) @map("total_pushes_in_session")
  totalNumbersSpentOnPush                   Int       @default(0) @map("total_numbers_spent_on_push")
  totalDigoutsInSession                     Int       @default(0) @map("total_digouts_in_session")
  totalNumbersSpentOnDigout                 Int       @default(0) @map("total_numbers_spent_on_digout")
  totalDisruptsInSession                    Int       @default(0) @map("total_disrupts_in_session")
  totalNumbersSpentOnDisrupt                Int       @default(0) @map("total_numbers_spent_on_disrupt")
  totalNumbersSpentInSession                Int       @default(0) @map("total_numbers_spent_in_session")
  hasBeenProcessed                          Boolean   @default(false) @map("has_been_processed")
  totalChallengesSubmittedInSession         Int       @default(0) @map("total_challenges_submitted_in_session")
  totalNumbersReturnedFromRemovalsInSession Int       @default(0) @map("total_numbers_returned_from_removals_in_session")
  totalRemovalsInSession                    Int       @default(0) @map("total_removals_in_session")

  @@map("streams")
}

/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model Mission {
  missionId     Int       @id @default(autoincrement()) @map("mission_id")
  title         String?   @map("title")
  description   String    @map("description")
  targetType    String    @map("target_type")
  targetValue   Int       @map("target_value")
  currentValue  Int       @default(0) @map("current_value")
  isExecuting   Boolean   @default(false) @map("is_executing")
  dateCreated   DateTime  @map("date_created")
  dateCompleted DateTime? @map("date_completed")

  @@map("missions")
}

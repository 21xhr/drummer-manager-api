generator client {
  provider = "prisma-client-js"
  // CRITICAL: Force bundling of the Vercel-compatible binary
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ChallengeStatus {
  ACTIVE
  ARCHIVED
  AUCTIONED
  COMPLETED
  FAILED
  IN_PROGRESS
  REMOVED
}

enum DurationType {
  ONE_OFF
  RECURRING
}

enum PlatformName {
  GAME_MASTER // Internal value for admin user
  KICK
  TWITCH
  YOUTUBE
}

enum CadenceUnit {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM_DAYS // X sessions every Y days
}


/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model Account {
  id                        Int             @id @default(autoincrement()) @map("account_id")
  
  // IDENTITY
  userId                    Int             @map("user_id") // FOREIGN KEY to the central user
  platformId                String          @map("platform_id")
  platformName              PlatformName    @map("platform_name") // Using the Enum!
  username                  String?         @map("username") // The mutable platform username/display name

  // HYBRID BALANCE (Mirroring Lumia)
  currentBalance            Int             @default(0) @map("current_balance") // The SoT for this specific platform balance
  
  // PLATFORM-SPECIFIC TIMESTAMPS (For accurate activity tracking per-platform)
  lastBalanceUpdate         DateTime?       @map("last_balance_update")
  lastActivityTimestamp     DateTime?       @map("last_activity_timestamp")
  lastLiveActivityTimestamp DateTime?       @map("last_live_activity_timestamp")
  
  // RELATIONSHIP
  user                      User            @relation("UserAccounts", fields: [userId], references: [id])

  // CRITICAL UNIQUE CONSTRAINT
  @@unique([platformId, platformName])
  @@map("accounts")
}


/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model User {
  id                                      Int       @id @default(autoincrement()) @map("user_id")  

  // TIMESTAMPS
  // NOTE: the activity timestamps are moved to the account level for accuracy!
  lastActivityTimestamp                 DateTime?   @map("last_activity_timestamp") // Keeping for *overall* user activity
  lastLiveActivityTimestamp             DateTime?   @map("last_live_activity_timestamp") // Keeping for *overall* user activity
  
  // WATERMARKS
  lastSeenStreamDay                     Int       @default(0) @map("last_seen_stream_day")
  lastProcessedDay                      Int       @default(0) // Internal: Tracks daysSinceInception checked by Cron
  lastSeenDay                           Int       @default(0) // Stat: Tracks the last Real-World Day user was active

  // COUNTERS
  activeOfflineDaysCount                Int       @default(0) @map("active_offline_days_count")
  activeStreamDaysCount                 Int       @default(0) @map("active_stream_days_count")
  
  // All total/game-wide stats remain here
  totalNumbersSpentGameWide             BigInt       @default(0) @map("total_numbers_spent_game_wide")
  totalNumbersReturnedFromRemovalsGameWide BigInt    @default(0) @map("total_numbers_returned_from_removals_game_wide")
  totalCausedByRemovals                 BigInt    @default(0) @map("total_caused_by_removals")
  totalToCommunityChest                 BigInt    @default(0) @map("total_to_community_chest")
  totalToPushers                        BigInt    @default(0) @map("total_to_pushers")

  // Game Metrics (User)
  lastExplorerDeduction                 DateTime? @map("last_explorer_deduction")
  dailyChallengeResetAt                 DateTime  @map("daily_challenge_reset_at")
  dailySubmissionCount                  Int       @default(0) @map("daily_submission_count")
  totalChallengesSubmitted              Int       @default(0) @map("total_challenges_submitted")
  totalRemovalsExecuted                 Int       @default(0) @map("total_removals_executed")
  totalReceivedFromRemovals             Int       @default(0) @map("total_received_from_removals")
  totalNumbersSpent                     BigInt       @default(0) @map("total_numbers_spent")
  totalDigoutsExecuted                  Int       @map("total_digouts_executed") @default(0)
  totalPushesExecuted                   Int       @default(0)
  totalDisruptsExecuted                 Int       @default(0)

  // Relationships (now one-to-many to Account)
  challenges                            Challenge[] @relation("Proposer")
  pushes                                Push[]
  tempQuotes                            TempQuote[]
  accounts                              Account[] @relation("UserAccounts")

  @@map("users")
}

/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model StreamStat {
  id                       Int @id
  streamDaysSinceInception Int @default(0) @map("stream_days_since_inception")
  daysSinceInception       Int @default(0) @map("days_since_inception")
  lastMaintenanceAt        DateTime?       @map("last_maintenance_at") 

  @@map("stream_stats")
}

/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model Challenge {
  challengeId               Int         @id @default(autoincrement()) @map("challenge_id")
  challengeText             Json        @map("challenge_text")
  category                  String      @map("category")
  durationType          DurationType    @map("duration_type")
  proposerUserId            Int         @map("proposer_user_id")
  status                ChallengeStatus @map("status")
  failureReason             String?     @map("failure_reason")
  isExecuting               Boolean     @default(false) @map("is_executing")
  timestampLastSessionTick DateTime?    @map("timestamp_last_session_tick") // Tracks the last time a session tick occurred for this challenge
  hasBeenAuctioned          Boolean     @default(false) @map("has_been_auctioned")
  hasBeenDiggedOut          Boolean     @default(false) @map("has_been_digged_out")
  auctionCost               Int         @default(0) @map("auction_cost")
  disruptCount              Int         @default(0) @map("disrupt_count")
  numbersRaised             Int         @default(0) @map("numbers_raised")
  totalNumbersSpent         BigInt      @default(0) @map("total_numbers_spent")
  totalPush                 Int         @default(0) @map("total_push")
  timestampSubmitted        DateTime    @map("timestamp_submitted")
  timestampLastActivation   DateTime    @map("timestamp_last_activation")
  timestampCompleted        DateTime?   @map("timestamp_completed")
  uniquePusher              Int         @default(0) @map("unique_pusher")
  pushBaseCost              Int         @default(21) @map("push_base_cost")
  submissionCost            Int         @map("submission_cost") // No default needed, as it's calculated on creation
  proposer                  User        @relation("Proposer", fields: [proposerUserId], references: [id])
  timestampLastStreamDayTicked   DateTime    @default(now()) // Tracks the last time streamDaysSinceActivation was incremented. To guard against double-ticking
  
  // Cadence Fields
  sessionCadenceText      String?         @map("session_cadence_text")
  cadenceUnit             CadenceUnit?    @map("cadence_unit")
  cadenceProgressCounter  Int             @default(0) @map("cadence_progress_counter")
  cadencePeriodStart      DateTime?       @map("cadence_period_start") // Will be set on FIRST EXECUTION or successful daily tick.
  cadenceRequiredCount    Int?            @default(1) @map("cadence_required_count") 

  // Lifecycle fields
  streamDaysSinceActivation Int           @default(0) @map("stream_days_since_activation")
  
  // Session Fields
  totalSessions             Int             @map("total_sessions") 
  currentSessionCount       Int @default(0) @map("current_session_count")
  sessionStartTimestamp     DateTime?    @map("session_start_timestamp") // Tracks when the current 21-min session began

  pushes                    Push[]
  tempQuotes                TempQuote[]


  @@map("challenges")
}

/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model Push {
  pushId      Int       @id @default(autoincrement()) @map("push_id")
  challengeId Int       @map("challenge_id")
  userId      Int       @map("user_id")
  cost        Int       @map("cost")
  timestamp   DateTime  @default(now()) @map("timestamp")
  quantity    Int       @default(1) @map("quantity")
  challenge   Challenge @relation(fields: [challengeId], references: [challengeId])
  user        User      @relation(fields: [userId], references: [id])

  @@map("pushes")
}

/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model TempQuote {
  quoteId          String    @id @map("quote_id")
  userId           Int       @map("user_id")
  challengeId      Int       @map("challenge_id")
  quantity         Int       @map("quantity")
  quotedCost       Int       @map("quoted_cost")
  timestampCreated DateTime  @map("timestamp_created")
  isLocked         Boolean   @default(false) @map("is_locked")
  challenge        Challenge @relation(fields: [challengeId], references: [challengeId])
  user             User      @relation(fields: [userId], references: [id])

  @@map("temp_quotes")
}

/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
model Stream {
  streamSessionId                           Int       @id @default(autoincrement()) @map("stream_session_id")
  currentStreamNumber                       Int       @map("current_stream_number")
  startTimestamp                            DateTime  @map("start_timestamp")
  endTimestamp                              DateTime? @map("end_timestamp")
  durationMinutes                           Int?      @map("duration_minutes")
  totalPushesInSession                      Int       @default(0) @map("total_pushes_in_session")
  totalNumbersSpentOnPush                   Int       @default(0) @map("total_numbers_spent_on_push")
  totalDigoutsInSession                     Int       @default(0) @map("total_digouts_in_session")
  totalNumbersSpentOnDigout                 Int       @default(0) @map("total_numbers_spent_on_digout")
  totalDisruptsInSession                    Int       @default(0) @map("total_disrupts_in_session")
  totalNumbersSpentOnDisrupt                Int       @default(0) @map("total_numbers_spent_on_disrupt")
  totalNumbersSpentInSession                Int       @default(0) @map("total_numbers_spent_in_session")
  hasBeenProcessed                          Boolean   @default(false) @map("has_been_processed")
  totalChallengesSubmittedInSession         Int       @default(0) @map("total_challenges_submitted_in_session")
  totalNumbersReturnedFromRemovalsInSession Int       @default(0) @map("total_numbers_returned_from_removals_in_session")
  totalRemovalsInSession                    Int       @default(0) @map("total_removals_in_session")

  @@map("streams")
}